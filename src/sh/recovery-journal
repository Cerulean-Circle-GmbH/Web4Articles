#!/usr/bin/env bash
set -euo pipefail

# Determine project root (script is in src/sh)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]:-$0}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
cd "$PROJECT_ROOT"

export TZ=UTC
TS_DIR=$(date -u +%Y-%m-%d-%H%M)
NOW_ISO=$(date -u +%FT%TZ)
NOW_HM=$(date -u +"%Y-%m-%d %H:%M UTC")

DEST_DIR="scrum.pmo/project.journal/$TS_DIR"
DEST_FILE="$DEST_DIR/project.state.md"
mkdir -p "$DEST_DIR"

# Inputs: a brief summary message via stdin or argument
SUMMARY_INPUT=${1:-}
if [ -z "${SUMMARY_INPUT}" ]; then
  if [ -t 0 ]; then
    echo "Usage: recovery-journal \"one-line summary\"" >&2
    exit 1
  else
    SUMMARY_INPUT=$(cat)
  fi
fi

{
  echo "[Back to Project Journal](../)"
  echo
  echo "# Project State â€” $NOW_HM"
  echo
  echo "**Status:** $SUMMARY_INPUT"
  echo
  echo "### Project status (ScrumMaster)"
  echo "- **Role**: ScrumMaster coordinating across sprints and ensuring policy compliance."
  echo "- **Branch**: $(git rev-parse --abbrev-ref HEAD)"
} > "$DEST_FILE"

printf "\n## %s\n%s\n" "$NOW_ISO" "**Summary:** $SUMMARY_INPUT" >> recovery.md

echo "Wrote $DEST_FILE and appended to recovery.md"


