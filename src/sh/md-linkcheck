#!/usr/bin/env bash
set -euo pipefail

# Determine project root (script is in src/sh)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]:-$0}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

cd "$PROJECT_ROOT"

broken=0
file_list=$(git ls-files '*.md' 2>/dev/null || find . -type f -name '*.md' | sed 's|^./||')
while IFS= read -r md; do
  [ -z "$md" ] && continue
  # Extract markdown links via grep and iterate
  grep -oE "\[[^\]]+\]\([^)]*\)" "$md" 2>/dev/null | while IFS= read -r link; do
    target=${link#*(}
    target=${target%)}
    [ -z "$target" ] && continue
    if [[ "$target" == http* || "$target" == mailto:* || "$target" == \#* || "$target" == *.svg || "$target" == *.png || "$target" == *.jpg || "$target" == *.gif ]]; then
      continue
    fi
    if [ ! -e "$target" ]; then
      echo "Broken link in $md -> $target" >&2
      broken=1
    fi
  done || true
done <<< "$file_list"

exit $broken


