#!/bin/bash
# Web4Articles Project Environment Configuration - Location Resilient
# Source this file to set up the project environment from any location
# Usage: source /path/to/project/source.env

# Function to find project root using git
alias ll='ls -la'

find_web4_root() {
    # First, check if we're sourcing from project root directly
    local source_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    if [ -f "$source_dir/package.json" ] || [ -f "$source_dir/README.md" ]; then
        echo "$source_dir"
        return 0
    fi
    
    # Try git (most reliable when in project)
    local git_root=$(git rev-parse --show-toplevel 2>/dev/null)
    if [ -n "$git_root" ] && [ -d "$git_root" ]; then
        # Verify it's Web4Articles project
        if [ -f "$git_root/package.json" ] || [ -f "$git_root/README.md" ]; then
            echo "$git_root"
            return 0
        fi
    fi
    
    # Fallback to source location
    echo "$source_dir"
}

# Set project root dynamically
export PROJECT_ROOT="$(find_web4_root)"

# Add scripts directory to PATH for easy access to all project scripts
export PATH="$PROJECT_ROOT/scripts:$PROJECT_ROOT/scripts/versions:$PATH"

# Add node_modules/.bin to PATH for project-specific tools
export PATH="$PROJECT_ROOT/node_modules/.bin:$PATH"

# Set TypeScript project configuration
export TS_NODE_PROJECT="$PROJECT_ROOT/tsconfig.json"

# Set Node.js to use ES modules
export NODE_OPTIONS="--experimental-specifier-resolution=node"

# Set default user for Web4 components (can be overridden)
export WEB4_USER="${USER:-unknown}"
export WEB4_HOSTNAME="${HOSTNAME:-localhost}"

# Component paths for easy reference
export WEB4_COMPONENTS="$PROJECT_ROOT/components"
export WEB4_SCRIPTS="$PROJECT_ROOT/scripts"
export WEB4_DOCS="$PROJECT_ROOT/docs"
export WEB4_SCRUM="$PROJECT_ROOT/scrum.pmo"

# Function to check if environment is properly set
web4_check_env() {
    echo "Web4Articles Environment Status:"
    echo "  PROJECT_ROOT: $PROJECT_ROOT"
    echo "  Current User: $WEB4_USER@$WEB4_HOSTNAME"
    echo "  Scripts available: $(ls -1 $WEB4_SCRIPTS/*.sh 2>/dev/null | wc -l)"
    echo "  Components: $(ls -1d $WEB4_COMPONENTS/*/ 2>/dev/null | wc -l)"
    
    # Check if key scripts are accessible
    if command -v requirement >/dev/null 2>&1; then
        echo "  ✅ requirement CLI is in PATH"
    else
        echo "  ❌ requirement CLI not found in PATH"
    fi
}

# Display confirmation when sourced
echo "🚀 Web4Articles environment loaded from: $PROJECT_ROOT"
echo "   Run 'web4_check_env' to verify setup"