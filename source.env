#!/bin/bash
# Web4Articles Project Environment Variables
# Source this file to set up component-aware environment

# Useful aliases
alias ll='ls -la'

# Project Root Detection
export WEB4_PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
echo "ðŸ  Web4Articles Project Root: $WEB4_PROJECT_ROOT"

# Component Context Detection
detect_component_context() {
    local current_dir="$PWD"
    local project_root="$WEB4_PROJECT_ROOT"
    
    # Check if we're inside a component directory
    if [[ "$current_dir" == *"/components/"* ]]; then
        # Extract component path pattern: /path/to/components/ComponentName/version
        local component_relative=$(echo "$current_dir" | sed "s|$project_root/||g")
        
        if [[ "$component_relative" =~ ^components/([^/]+)/([^/]+) ]]; then
            local component_name="${BASH_REMATCH[1]}"
            local component_version="${BASH_REMATCH[2]}"
            local component_root="$project_root/components/$component_name/$component_version"
            
            export WEB4_COMPONENT_CONTEXT="true"
            export WEB4_COMPONENT_NAME="$component_name"
            export WEB4_COMPONENT_VERSION="$component_version"
            export WEB4_COMPONENT_ROOT="$component_root"
            
            echo "ðŸ”§ Component Context: $component_name/$component_version"
            echo "ðŸ“ Component Root: $component_root"
        else
            export WEB4_COMPONENT_CONTEXT="false"
            unset WEB4_COMPONENT_NAME WEB4_COMPONENT_VERSION WEB4_COMPONENT_ROOT
            echo "ðŸ“‚ Global Context (not in component)"
        fi
    else
        export WEB4_COMPONENT_CONTEXT="false"
        unset WEB4_COMPONENT_NAME WEB4_COMPONENT_VERSION WEB4_COMPONENT_ROOT
        echo "ðŸ“‚ Global Context (not in component)"
    fi
}

# Auto-detect component context when sourcing
detect_component_context

# Helper function to refresh component context (call when changing directories)
refresh_context() {
    detect_component_context
}

# Export functions for use in subshells
export -f detect_component_context refresh_context

# Add scripts to PATH for easy CLI access
export PATH="$WEB4_PROJECT_ROOT/scripts:$WEB4_PROJECT_ROOT/scripts/versions:$PATH"

# Fix symlinks in scripts/versions to use correct project path
if [ -d "$WEB4_PROJECT_ROOT/scripts/versions" ]; then
    for link in "$WEB4_PROJECT_ROOT/scripts/versions"/*; do
        if [ -L "$link" ] && [[ "$(readlink "$link")" == /workspace/* ]]; then
            target=$(readlink "$link")
            new_target="${target/\/workspace\//$WEB4_PROJECT_ROOT/}"
            if [ -f "$new_target" ]; then
                ln -sf "$new_target" "$link"
                echo "ðŸ”§ Fixed symlink: $(basename "$link") -> $new_target"
            fi
        fi
    done
fi

echo "ðŸ”¨ Added Web4Articles scripts to PATH"

echo "âœ… Web4Articles environment loaded. Use 'refresh_context' when changing directories."