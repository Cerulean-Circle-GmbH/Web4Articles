#!/bin/bash
# sessionSummary - Automated PDCA Session Analysis Tool
# Purpose: Extract TRON quotes and generate systematic MD tables

# Get project root
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Simple implementation using grep and awk
SESSION_PATH="$1"
OUTPUT_FILE="$2"
BRANCH="${3:-dev/req0305}"

if [ -z "$SESSION_PATH" ]; then
    echo "Usage: sessionSummary <sessionPath> [outputFile] [branch]"
    echo "Example: sessionSummary scrum.pmo/project.journal/2025-09-11-UTC-0007-session"
    exit 1
fi

echo "🚀 sessionSummary Tool Starting..."
echo "🔍 Analyzing session: $SESSION_PATH"

# Find all PDCA files
PDCA_FILES=$(find "$SESSION_PATH" -name "*.pdca.md" -o -name "*.md" | sort)
FILE_COUNT=$(echo "$PDCA_FILES" | wc -l)

echo "📋 Found $FILE_COUNT PDCA files"

# Generate table header
TABLE="## **📊 Complete Session Analysis Table (Chronological Order with Git SHAs and UTC Times)**

**Note:** Table shows chronological progression with exact TRON quotes. Total PDCAs analyzed: $FILE_COUNT

| **Git SHA** | **UTC Time** | **PDCA Source/Evidence** | **Exact TRON Quotes** | **Key Learning/Achievement** |
|-------------|--------------|--------------------------|------------------------|-----------------------------|"

# Process each file
while IFS= read -r file; do
    if [ -n "$file" ]; then
        echo "✅ Analyzing: $(basename "$file")"
        
        # Get original commit info by searching for the PDCA filename in dev/req0305 branch
        FILENAME=$(basename "$file")
        
        # Search for this PDCA in dev/req0305 branch history
        ORIGINAL_SHA=$(git log origin/dev/req0305 --format="%h" --name-only | grep -B1 "$FILENAME" | head -1 2>/dev/null || echo "unknown")
        
        if [ "$ORIGINAL_SHA" != "unknown" ]; then
            ORIGINAL_TIMESTAMP=$(git log origin/dev/req0305 --format="%ai" "$ORIGINAL_SHA" 2>/dev/null || stat -c %y "$file")
        else
            # Fallback: search by commit message containing the PDCA title
            PDCA_TITLE=$(grep "# 📋" "$file" | head -1 | sed 's/# 📋 \*\*PDCA Cycle: //' | sed 's/ - .*\*\*//' 2>/dev/null || echo "")
            if [ -n "$PDCA_TITLE" ]; then
                ORIGINAL_SHA=$(git log origin/dev/req0305 --format="%h" --grep="$PDCA_TITLE" | head -1 2>/dev/null || echo "unknown")
                ORIGINAL_TIMESTAMP=$(git log origin/dev/req0305 --format="%ai" "$ORIGINAL_SHA" 2>/dev/null || stat -c %y "$file")
            else
                ORIGINAL_SHA="unknown"
                ORIGINAL_TIMESTAMP=$(stat -c %y "$file")
            fi
        fi
        
        SHA="$ORIGINAL_SHA"
        
        # Convert to UTC format YYYY-MM-DD-UTC-HHMM
        UTC_TIME=$(date -d "$ORIGINAL_TIMESTAMP" -u +"%Y-%m-%d-UTC-%H%M" 2>/dev/null || echo "unknown")
        
        # Get relative path
        REL_PATH=$(realpath --relative-to="$PROJECT_ROOT" "$file" 2>/dev/null || echo "$file")
        
        # Extract TRON quotes
        QUOTES=$(grep -A 20 "### \*\*TRON Feedback" "$file" | sed -n '/```quote/,/```/p' | grep -v '```' | tr '\n' '\\n' || echo "No quotes")
        
        # Extract achievement from title
        ACHIEVEMENT=$(grep "# 📋" "$file" | sed 's/# 📋 \*\*PDCA Cycle: //' | sed 's/ - .*\*\*//' || echo "Unknown")
        
        # Generate dual link
        FILENAME=$(basename "$file")
        GITHUB_URL="https://github.com/Cerulean-Circle-GmbH/Web4Articles/blob/$BRANCH/$REL_PATH"
        DUAL_LINK="[GitHub]($GITHUB_URL) \\| [$FILENAME](N/A)"
        
        # Add to table
        TABLE="$TABLE
| **$SHA** | **$UTC_TIME** | $DUAL_LINK | \`$QUOTES\` | **$ACHIEVEMENT** |"
    fi
done <<< "$PDCA_FILES"

echo ""
echo "📊 Generated Table:"
echo "$TABLE"

if [ -n "$OUTPUT_FILE" ]; then
    echo "$TABLE" > "$OUTPUT_FILE"
    echo ""
    echo "💾 Table written to: $OUTPUT_FILE"
fi

echo ""
echo "✅ sessionSummary Complete - Analyzed $FILE_COUNT PDCAs"