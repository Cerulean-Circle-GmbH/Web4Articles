#!/bin/bash
# setup-once-links.sh - Build process integration for ONCE CLI links
# Follows Web4 CLI pattern - generates TypeScript-based CLI launchers

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
SCRIPTS_DIR="$PROJECT_ROOT/scripts"
VERSIONS_DIR="$SCRIPTS_DIR/versions"
ONCE_VERSION="0.1.0.2"

echo "üîß Setting up ONCE CLI links (TypeScript-based)..."

# Create directories if they don't exist
mkdir -p "$VERSIONS_DIR"

# Create versioned ONCE script
ONCE_VERSIONED="$VERSIONS_DIR/once-v$ONCE_VERSION"
cat > "$ONCE_VERSIONED" << 'EOF'
#!/bin/bash
# ONCE CLI Tool v0.1.0.2 - Location Resilient Launcher  
# Follows Web4 CLI pattern - delegates to TypeScript CLI
# Generated by setup-once-links.sh

find_project_root() {
    local current_dir="$PWD"
    local git_root=$(git rev-parse --show-toplevel 2>/dev/null)
    if [ -n "$git_root" ]; then
        echo "$git_root"
        return 0
    fi
    
    local dir="$current_dir"
    while [ "$dir" != "/" ]; do
        if [ -f "$dir/package.json" ]; then
            echo "$dir"
            return 0
        fi
        dir=$(dirname "$dir")
    done
    
    echo "$current_dir"
}

PROJECT_ROOT=$(find_project_root)
if [ -z "$PROJECT_ROOT" ]; then
    echo "‚ùå Error: Not in a Web4Articles project directory"
    exit 1
fi

export PROJECT_ROOT

# Find the CLI in the components directory structure
ONCE_VERSION="0.1.0.2"
COMPONENT_DIR="$PROJECT_ROOT/components/ONCE/$ONCE_VERSION"
CLI_SOURCE_PATH="$COMPONENT_DIR/src/ts/layer5/OnceCLI.ts"
CLI_PATH="$COMPONENT_DIR/dist/ts/layer5/OnceCLI.js"

# Check if compiled CLI exists, if not try to build
if [ ! -f "$CLI_PATH" ]; then
    if [ ! -f "$CLI_SOURCE_PATH" ]; then
        echo "‚ùå CLI source not found at: $CLI_SOURCE_PATH"
        echo "üìÅ Component directory: $COMPONENT_DIR"
        exit 1
    fi
    
    echo "üî® Building ONCE CLI v$ONCE_VERSION..."
    cd "$COMPONENT_DIR"
    
    # Install dependencies if needed
    if [ ! -d "node_modules" ]; then
        npm install
    fi
    
    # Build the project
    if ! npm run build; then
        echo "‚ùå Build failed for ONCE v$ONCE_VERSION"
        exit 1
    fi
    
    if [ ! -f "$CLI_PATH" ]; then
        echo "‚ùå CLI still not found at: $CLI_PATH after build"
        exit 1
    fi
fi

# Check for Node.js
if ! command -v node >/dev/null 2>&1; then
    echo "‚ùå Error: Node.js is required but not installed"
    exit 1
fi

# Execute the TypeScript CLI with all arguments via bin/once entry point
cd "$PROJECT_ROOT"
node "$COMPONENT_DIR/bin/once" "$@"

# All above logic handles the TypeScript CLI execution
EOF

# Make versioned script executable
chmod +x "$ONCE_VERSIONED"

# Create latest ONCE script
ONCE_LATEST="$SCRIPTS_DIR/once"
cat > "$ONCE_LATEST" << 'EOF'
#!/bin/bash
# ONCE CLI Tool - Latest Version Launcher (Location Resilient)
# Follows Web4 CLI pattern - delegates to TypeScript CLI
# Generated by setup-once-links.sh

find_project_root() {
    local current_dir="$PWD"
    local git_root=$(git rev-parse --show-toplevel 2>/dev/null)
    if [ -n "$git_root" ]; then
        echo "$git_root"
        return 0
    fi
    
    local dir="$current_dir"
    while [ "$dir" != "/" ]; do
        if [ -f "$dir/package.json" ]; then
            echo "$dir"
            return 0
        fi
        dir=$(dirname "$dir")
    done
    
    echo "$current_dir"
}

PROJECT_ROOT=$(find_project_root)
if [ -z "$PROJECT_ROOT" ]; then
    echo "‚ùå Error: Not in a Web4Articles project directory"
    exit 1
fi

export PROJECT_ROOT

# Find the CLI in the components directory structure
ONCE_VERSION="0.1.0.2"
COMPONENT_DIR="$PROJECT_ROOT/components/ONCE/$ONCE_VERSION"
CLI_SOURCE_PATH="$COMPONENT_DIR/src/ts/layer5/OnceCLI.ts"
CLI_PATH="$COMPONENT_DIR/dist/ts/layer5/OnceCLI.js"

# Check if compiled CLI exists, if not try to build
if [ ! -f "$CLI_PATH" ]; then
    if [ ! -f "$CLI_SOURCE_PATH" ]; then
        echo "‚ùå CLI source not found at: $CLI_SOURCE_PATH"
        echo "üìÅ Component directory: $COMPONENT_DIR"
        exit 1
    fi
    
    echo "üî® Building ONCE CLI v$ONCE_VERSION..."
    cd "$COMPONENT_DIR"
    
    # Install dependencies if needed
    if [ ! -d "node_modules" ]; then
        npm install
    fi
    
    # Build the project
    if ! npm run build; then
        echo "‚ùå Build failed for ONCE v$ONCE_VERSION"
        exit 1
    fi
    
    if [ ! -f "$CLI_PATH" ]; then
        echo "‚ùå CLI still not found at: $CLI_PATH after build"
        exit 1
    fi
fi

# Check for Node.js
if ! command -v node >/dev/null 2>&1; then
    echo "‚ùå Error: Node.js is required but not installed"
    exit 1
fi

# Execute the TypeScript CLI with all arguments via bin/once entry point
cd "$PROJECT_ROOT"
node "$COMPONENT_DIR/bin/once" "$@"

# No usage in shell script - delegate to TypeScript CLI

# No command handling in shell script - delegate everything to TypeScript CLI
EOF

# Make latest script executable
chmod +x "$ONCE_LATEST"

echo "‚úÖ ONCE demo links created:"
echo "   üìÅ Versioned: $ONCE_VERSIONED"
echo "   üìÅ Latest: $ONCE_LATEST"
echo ""
echo "üé≠ Usage:"
echo "   scripts/versions/once-v$ONCE_VERSION    # Specific version"
echo "   scripts/once                            # Latest version"
echo ""
echo "üåê Demo features:"
echo "   ‚Ä¢ Cross-platform browser auto-opening"
echo "   ‚Ä¢ Web4 Message component integration"
echo "   ‚Ä¢ P2P scenario acknowledgments"
echo "   ‚Ä¢ Interactive demo controls"
