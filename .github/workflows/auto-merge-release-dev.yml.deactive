name: Auto-merge to release/dev

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  auto-merge:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
    - name: Fetch all branches
      run: git fetch --all
        
    - name: Checkout release/dev
      run: |
        git checkout release/dev || git checkout -b release/dev origin/release/dev
        
    - name: Merge main into release/dev
      run: |
        echo "Merging main (production) into release/dev after PR merge..."
        git merge origin/main --no-ff -m "chore: Auto-merge main (production) into release/dev
        
        Continuous integration merge after PR #${{ github.event.pull_request.number }} merged
        PR Title: ${{ github.event.pull_request.title }}
        Merged by: ${{ github.event.pull_request.merged_by.login }}
        
        [skip ci]"
        
    - name: Push to release/dev
      run: |
        git push origin release/dev || echo "Push failed - may need manual intervention"
      
    - name: Create merge report
      if: always()
      run: |
        echo "## Auto-merge Report" >> $GITHUB_STEP_SUMMARY
        echo "- PR: #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
        echo "- Title: ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
        echo "- Source: main (production)" >> $GITHUB_STEP_SUMMARY
        echo "- Target: release/dev" >> $GITHUB_STEP_SUMMARY
        echo "- Merged by: ${{ github.event.pull_request.merged_by.login }}" >> $GITHUB_STEP_SUMMARY
        echo "- Time: $(date -u +%Y-%m-%d' '%H:%M:%S' UTC')" >> $GITHUB_STEP_SUMMARY
        
        if [ $? -eq 0 ]; then
          echo "- Status: Success ✅" >> $GITHUB_STEP_SUMMARY
        else
          echo "- Status: Failed ❌ - Manual intervention may be required" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Handle merge conflicts
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.name,
            title: 'Auto-merge conflict: main → release/dev',
            body: `## Auto-merge Failed
            
            The automatic merge from main to release/dev has failed after PR #${{ github.event.pull_request.number }} was merged.
            
            **Details:**
            - PR: #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}
            - Merged by: ${{ github.event.pull_request.merged_by.login }}
            - Time: ${new Date().toISOString()}
            
            **Action Required:**
            Please manually resolve the conflicts and merge main into release/dev.
            
            \`\`\`bash
            git checkout release/dev
            git merge main
            # Resolve conflicts
            git push origin release/dev
            \`\`\`
            `,
            labels: ['auto-merge', 'merge-conflict', 'release/dev']
          })