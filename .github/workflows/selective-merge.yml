name: Selective Merge to Release/Dev

on:
  pull_request:
    types: [closed]
    branches: [main]
  workflow_dispatch:
    inputs:
      branch_to_merge:
        description: 'Branch name to merge into release/dev'
        required: true
        type: string

jobs:
  merge-to-release-dev:
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
    - name: Checkout release/dev
      run: git checkout release/dev
      
    - name: Merge PR branch or specified branch
      run: |
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          # Merge the PR's head branch
          BRANCH="${{ github.event.pull_request.head.ref }}"
          echo "Merging PR branch: $BRANCH"
        else
          # Manual workflow dispatch
          BRANCH="${{ github.event.inputs.branch_to_merge }}"
          echo "Merging specified branch: $BRANCH"
        fi
        
        # Attempt merge
        git merge origin/$BRANCH --no-ff -m "chore: Merge $BRANCH into release/dev
        
        Automated merge after PR approval or manual trigger
        Branch: $BRANCH
        Triggered by: ${{ github.actor }}"
        
    - name: Run tests
      run: |
        npm install
        npm test || echo "Tests failed but continuing..."
        
    - name: Push to release/dev
      run: git push origin release/dev
      
    - name: Create merge report
      if: success()
      run: |
        echo "## Merge Report" >> $GITHUB_STEP_SUMMARY
        echo "- Branch merged: $BRANCH" >> $GITHUB_STEP_SUMMARY
        echo "- Target: release/dev" >> $GITHUB_STEP_SUMMARY
        echo "- Status: Success âœ…" >> $GITHUB_STEP_SUMMARY