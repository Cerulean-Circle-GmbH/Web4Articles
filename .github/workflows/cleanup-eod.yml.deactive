name: EOD Cleanup Agent
on:
  schedule:
    - cron: '0 22 * * *'  # 10 PM UTC daily
  workflow_dispatch:       # Manual trigger
    inputs:
      dryRun:
        description: 'Run in dry-run mode'
        type: boolean
        default: false

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git operations
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: |
          npm install -g ts-node typescript
          npm install glob
      
      - name: Run Cleanup Agent
        id: cleanup
        run: |
          if [ "${{ github.event.inputs.dryRun }}" = "true" ]; then
            node --loader ts-node/esm tools/cleanup-agent.ts --dry-run
          else
            node --loader ts-node/esm tools/cleanup-agent.ts
          fi
        continue-on-error: true
      
      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true' && github.event.inputs.dryRun != 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: EOD structural cleanup ðŸ§¹"
          title: "[Auto] EOD Structural Cleanup - ${{ github.run_id }}"
          body: |
            ## ðŸ§¹ Automated EOD Cleanup
            
            This PR contains automated structural fixes performed by the cleanup agent.
            
            ### Changes Made
            - Moved misplaced PDCAs to proper journal sessions
            - Organized articles in correct directories
            - Fixed broken links from file moves
            - Enforced sprint folder structure standards
            
            ### Review Instructions
            1. Check that all file moves preserve content
            2. Verify links still work correctly
            3. Ensure no critical files were moved incorrectly
            
            ### Report
            See `cleanup-reports/` for detailed report of changes.
            
            ---
            *Generated by EOD Cleanup Agent workflow run #${{ github.run_id }}*
          branch: cleanup/eod-${{ github.run_id }}
          delete-branch: true
          labels: |
            cleanup
            automated
            
      - name: Upload cleanup report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: cleanup-report-${{ github.run_id }}
          path: cleanup-reports/
          retention-days: 30
          
      - name: Notify on failure
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'EOD Cleanup Agent Failed',
              body: `The automated EOD cleanup failed. Please check [workflow run #${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              labels: ['bug', 'cleanup']
            })