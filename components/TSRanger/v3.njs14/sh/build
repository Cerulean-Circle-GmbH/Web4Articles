#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "$0")/../.." && pwd)"
cd "$ROOT"

# Prepare mutated sources: strip .ts from import specifiers
rm -rf v3.njs14/src.mut v3.njs14/v2.src.mut dist.njs14
mkdir -p v3.njs14/src.mut/ts v3.njs14/v2.src.mut/ts
cp -a src/ts/. v3.njs14/src.mut/ts/
if [[ -d v2/src/ts ]]; then cp -a v2/src/ts/. v3.njs14/v2.src.mut/ts/ || true; fi

# Rewrite imports in mutated tree: remove .ts extensions before closing quote
find v3.njs14/src.mut v3.njs14/v2.src.mut -type f -name '*.ts' -print0 | while IFS= read -r -d '' f; do
  # ESM imports: from "./x.ts"; -> from "./x"
  sed -i.bak -E "s/(from\s+['\"]\.\.?\/[A-Za-z0-9_\/.-]+)\.ts(['\"][^\n]*;)/\1\2/g" "$f" && rm -f "$f.bak"
  # Dynamic imports: import("./x.ts") -> import("./x")
  sed -i.bak -E "s/(import\s*\(\s*['\"]\.\.?\/[A-Za-z0-9_\/.-]+)\.ts(['\"][^\)]*\))/\1\2/g" "$f" && rm -f "$f.bak"

done

# Compile mutated sources
if [[ -x ./node_modules/.bin/tsc ]]; then
  ./node_modules/.bin/tsc -p v3.njs14/tsconfig.njs14.json
elif command -v tsc >/dev/null 2>&1; then
  tsc -p v3.njs14/tsconfig.njs14.json
else
  echo "TypeScript compiler not found. Install with: npm i -D typescript@4.9.5" >&2
  exit 1
fi

# Postprocess to add .js extensions
node v3.njs14/postprocess.mjs