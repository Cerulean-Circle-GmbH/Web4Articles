#!/bin/bash

# Web4 ONCE Component Shell Starter
# Checks environment, builds dependencies, delegates to CLI
# Following Build component shell starter pattern

set -euo pipefail

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
COMPONENT_DIR="$SCRIPT_DIR"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "üîó Web4 ONCE Component v0.3.0.2 - Object Network Communication Engine"
echo "üìÇ Component: $COMPONENT_DIR"

# Use Build component for proper dependency resolution and build order
use_build_component() {
    local BUILD_COMPONENT="$COMPONENT_DIR/../../Build/0.3.0.3"
    
    if [ -d "$BUILD_COMPONENT" ]; then
        echo "üèóÔ∏è Using Build component for systematic dependency building..."
        
        # Use Build component buildWithDependencies for proper order
        cd "$BUILD_COMPONENT"
        npm install >/dev/null 2>&1 || true
        npm run build >/dev/null 2>&1 || true
        
        # Use Build component to build ONCE with all dependencies
        node -e "
        const { DefaultBuild } = require('./dist/ts/layer2/DefaultBuild.js');
        const build = new DefaultBuild();
        build.buildWithDependencies('/workspace/components/ONCE/0.3.0.2')
          .then(success => {
            if (success) {
              console.log('‚úÖ Build: ONCE and all dependencies built successfully');
              process.exit(0);
            } else {
              console.log('‚ùå Build: ONCE dependency building failed');
              process.exit(1);
            }
          })
          .catch(error => {
            console.log('‚ùå Build: Error during dependency building:', error.message);
            process.exit(1);
          });
        " || {
            echo -e "${RED}‚ùå Build component dependency building failed${NC}"
            exit 1
        }
        
        echo -e "${GREEN}‚úÖ Build chain complete - ONCE ready for execution${NC}"
    else
        echo -e "${RED}‚ùå Build component not available${NC}"
        exit 1
    fi
}

# Enhanced fallback build with dependency detection
enhanced_fallback_build() {
    echo "üîç Detecting ONCE component dependencies..."
    
    # Basic environment check
    command -v node >/dev/null 2>&1 || {
        echo -e "${RED}‚ùå Node.js required but not installed${NC}"
        exit 1
    }
    
    command -v npm >/dev/null 2>&1 || {
        echo -e "${RED}‚ùå NPM required but not installed${NC}"
        exit 1
    }
    
    # Build foundation components first (ONCE dependencies)
    build_foundation_if_needed() {
        local FOUNDATION_COMPONENTS=(
            "IOR:/workspace/components/IOR/0.3.0.0"
            "Scenario:/workspace/components/Scenario/0.1.3.0" 
            "User:/workspace/components/User/0.1.3.0"
        )
        
        for comp_info in "${FOUNDATION_COMPONENTS[@]}"; do
            local comp_name="${comp_info%%:*}"
            local comp_path="${comp_info##*:}"
            
            if [ -d "$comp_path" ] && [ ! -d "$comp_path/dist" ]; then
                echo "üî® Building foundation component: $comp_name..."
                cd "$comp_path"
                npm install >/dev/null 2>&1
                npm run build >/dev/null 2>&1 || npx tsc >/dev/null 2>&1
                echo -e "${GREEN}‚úÖ $comp_name built${NC}"
            fi
        done
    }
    
    # Use Build component for systematic dependency building - no fallback
    use_build_component
    
    echo -e "${GREEN}‚úÖ Enhanced fallback build complete${NC}"
}

# Deinstall functionality now implemented in DefaultONCE.ts following Web4 principles
# CLI delegation: shell script ‚Üí ONCECLI ‚Üí DefaultONCE.deinstall() method

# Main execution
main() {
    echo "üîç Setting up ONCE environment..."
    
    # Use Build component for setup
    use_build_component
    
    echo "üöÄ Delegating to ONCE CLI..."
    
    # Delegate all arguments to CLI - must exist after proper building
    if [ -f "$COMPONENT_DIR/dist/ts/layer5/ONCECLI.js" ]; then
        node "$COMPONENT_DIR/dist/ts/layer5/ONCECLI.js" "$@"
    else
        echo -e "${RED}‚ùå ONCE CLI not found after build - dependency building failed${NC}"
        echo "üí° All dependencies must build successfully for ONCE to work"
        exit 1
    fi
}

# Execute with all arguments
main "$@"