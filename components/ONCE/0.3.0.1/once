#!/bin/bash

# Web4 ONCE Component Shell Starter v0.3.0.1
# Web4-Compliant: Uses proper layer architecture
# Eliminates StandaloneONCE DORY leftover

set -euo pipefail

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
COMPONENT_DIR="$SCRIPT_DIR"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "üîó Web4 ONCE Component v0.3.0.1 - Object Network Communication Engine"
echo "üìÇ Component: $COMPONENT_DIR"

# Use Build component for comprehensive build chain
use_build_component() {
    local BUILD_COMPONENT="$COMPONENT_DIR/../../Build/latest"
    
    if [ -x "$BUILD_COMPONENT/build" ]; then
        echo "üèóÔ∏è Triggering comprehensive build chain for ONCE..."
        
        # Trigger complete build chain for ONCE component
        "$BUILD_COMPONENT/build" buildComponent ONCE || {
            echo -e "${RED}‚ùå Comprehensive build chain failed for ONCE${NC}"
            exit 1
        }
        
        echo -e "${GREEN}‚úÖ Build chain complete - ONCE ready for execution${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è Build component not available, using enhanced fallback...${NC}"
        enhanced_fallback_build
    fi
}

# Enhanced fallback build with dependency detection
enhanced_fallback_build() {
    echo "üîç Detecting ONCE component dependencies..."
    
    # Basic environment check
    command -v node >/dev/null 2>&1 || {
        echo -e "${RED}‚ùå Node.js required but not installed${NC}"
        exit 1
    }
    
    command -v npm >/dev/null 2>&1 || {
        echo -e "${RED}‚ùå NPM required but not installed${NC}"
        exit 1
    }
    
    # Build ONCE component (Web4-compliant)
    if [ -f "$COMPONENT_DIR/package.json" ]; then
        echo "üîß Building ONCE component (Web4-compliant v0.3.0.1)..."
        cd "$COMPONENT_DIR"
        npm install >/dev/null 2>&1
        npx tsc >/dev/null 2>&1
        echo -e "${GREEN}‚úÖ ONCE v0.3.0.1 built${NC}"
    fi
    
    echo -e "${GREEN}‚úÖ Enhanced fallback build complete${NC}"
}

# Main execution
main() {
    # Check if this is a deinstall command - bypass environment setup
    if [ "${1:-}" = "deinstall" ]; then
        echo "üßπ ONCE Deinstall - Direct execution"
        
        # Build Web4-compliant ONCE if needed (minimal setup)
        if [ ! -f "$COMPONENT_DIR/dist/ts/layer5/ONCECLI.js" ]; then
            echo "üîß Building Web4-compliant ONCE for deinstall..."
            cd "$COMPONENT_DIR"
            npx tsc >/dev/null 2>&1
        fi
        
        # Execute deinstall directly
        node "$COMPONENT_DIR/dist/ts/layer5/ONCECLI.js" deinstall
        return
    fi
    
    echo "üîç Setting up ONCE environment..."
    
    # Use Build component for setup
    use_build_component
    
    echo "üöÄ Delegating to Web4-Compliant ONCE CLI..."
    
    # Use Web4-compliant ONCECLI (proper layer5 architecture)
    if [ -f "$COMPONENT_DIR/dist/ts/layer5/ONCECLI.js" ]; then
        node "$COMPONENT_DIR/dist/ts/layer5/ONCECLI.js" "$@"
    else
        echo -e "${RED}‚ùå Web4-compliant ONCE CLI not found. Build may have failed.${NC}"
        echo "Try running: npm run build"
        exit 1
    fi
}

# Execute with all arguments
main "$@"