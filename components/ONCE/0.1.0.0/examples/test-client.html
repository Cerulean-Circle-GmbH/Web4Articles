<!DOCTYPE html>
<html>
<head>
    <title>ONCE WebSocket Test</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { margin: 5px; padding: 10px; }
        pre { background: #f0f0f0; padding: 10px; }
    </style>
</head>
<body>
    <h1>ONCE Server Test Client</h1>
    <div>
        <button onclick="testHealth()">Test Health Endpoint</button>
        <button onclick="testWebSocket()">Test WebSocket</button>
        <button onclick="requestScenarios()">Request Scenarios</button>
        <button onclick="discoverPeers()">Discover Peers</button>
    </div>
    <h2>Results:</h2>
    <div id="results"></div>

    <script>
        let ws = null;
        
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            results.appendChild(div);
        }

        async function testHealth() {
            try {
                const response = await fetch('http://localhost:8080/health');
                const data = await response.json();
                log('Health check successful:', 'success');
                log(JSON.stringify(data, null, 2), 'info');
            } catch (error) {
                log('Health check failed: ' + error.message, 'error');
            }
        }

        function testWebSocket() {
            try {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    log('WebSocket already connected', 'info');
                    return;
                }

                ws = new WebSocket('ws://localhost:8080');
                
                ws.onopen = () => {
                    log('WebSocket connected!', 'success');
                };

                ws.onmessage = (event) => {
                    log('Received: ' + event.data, 'info');
                };

                ws.onerror = (error) => {
                    log('WebSocket error: ' + error, 'error');
                };

                ws.onclose = () => {
                    log('WebSocket closed', 'info');
                };
            } catch (error) {
                log('WebSocket connection failed: ' + error.message, 'error');
            }
        }

        function requestScenarios() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('Please connect WebSocket first', 'error');
                return;
            }

            // Request user scenario
            ws.send(JSON.stringify({
                type: 'request-scenario',
                scenarioId: 'af0b6e99-85c9-4ce5-9945-031767f375c9'
            }));
            log('Requested user scenario', 'info');
        }

        function discoverPeers() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('Please connect WebSocket first', 'error');
                return;
            }

            ws.send(JSON.stringify({
                type: 'discover-peers'
            }));
            log('Discovering peers...', 'info');
        }
    </script>
</body>
</html>