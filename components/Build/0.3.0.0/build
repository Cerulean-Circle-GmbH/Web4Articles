#!/bin/bash

# Web4 Build Component Shell Starter
# Checks environment, installs dependencies if needed, delegates to CLI
# Following comprehensive implementation plan Phase 1a

set -euo pipefail

# Get script directory
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
COMPONENT_DIR="$SCRIPT_DIR"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "üèóÔ∏è Web4 Build Component v0.3.0.0"
echo "üìÇ Component: $COMPONENT_DIR"

# Check if Node.js is available
check_node() {
    if command -v node >/dev/null 2>&1; then
        NODE_VERSION=$(node --version)
        echo -e "${GREEN}‚úÖ Node.js found: $NODE_VERSION${NC}"
        return 0
    else
        echo -e "${RED}‚ùå Node.js not found${NC}"
        return 1
    fi
}

# Check if NPM is available
check_npm() {
    if command -v npm >/dev/null 2>&1; then
        NPM_VERSION=$(npm --version)
        echo -e "${GREEN}‚úÖ NPM found: $NPM_VERSION${NC}"
        return 0
    else
        echo -e "${RED}‚ùå NPM not found${NC}"
        return 1
    fi
}

# Install Node.js (worst case scenario)
install_node() {
    echo -e "${YELLOW}üì¶ Installing Node.js...${NC}"
    
    # Platform-specific installation
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        # Linux installation
        curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
        sudo apt-get install -y nodejs
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS installation
        if command -v brew >/dev/null 2>&1; then
            brew install node
        else
            echo -e "${RED}‚ùå Homebrew required for automatic Node.js installation on macOS${NC}"
            exit 1
        fi
    else
        echo -e "${RED}‚ùå Automatic Node.js installation not supported on this platform${NC}"
        echo "Please install Node.js manually: https://nodejs.org/"
        exit 1
    fi
}

# Install NPM (usually comes with Node.js)
install_npm() {
    echo -e "${YELLOW}üì¶ Installing NPM...${NC}"
    
    # NPM usually comes with Node.js, but can be installed separately
    if command -v node >/dev/null 2>&1; then
        npm install -g npm@latest
    else
        echo -e "${RED}‚ùå Node.js required for NPM installation${NC}"
        exit 1
    fi
}

# Build component with comprehensive build chain
build_dependencies() {
    echo "üèóÔ∏è Building comprehensive Web4 ecosystem..."
    
    # Build foundation components first
    build_component_if_needed "IOR" "/workspace/components/IOR/0.3.0.0"
    build_component_if_needed "Scenario" "/workspace/components/Scenario/0.1.3.0" 
    build_component_if_needed "User" "/workspace/components/User/0.1.3.0"
    
    # Build this component (Build)
    if [ -f "$COMPONENT_DIR/package.json" ]; then
        cd "$COMPONENT_DIR"
        npm install
        npm run build 2>/dev/null || npx tsc
    fi
    
    echo -e "${GREEN}‚úÖ Comprehensive build chain complete${NC}"
}

# Build individual component if needed
build_component_if_needed() {
    local COMP_NAME="$1"
    local COMP_PATH="$2"
    
    if [ -d "$COMP_PATH" ]; then
        echo "üî® Building $COMP_NAME..."
        
        # Install dependencies
        if [ -f "$COMP_PATH/package.json" ]; then
            cd "$COMP_PATH"
            npm install >/dev/null 2>&1
        fi
        
        # Build TypeScript  
        if [ -f "$COMP_PATH/tsconfig.json" ]; then
            cd "$COMP_PATH"
            npm run build >/dev/null 2>&1 || npx tsc >/dev/null 2>&1
        fi
        
        echo -e "${GREEN}‚úÖ $COMP_NAME built${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è $COMP_NAME not found at $COMP_PATH${NC}"
    fi
}

# Main execution flow
main() {
    echo "üîç Checking environment..."
    
    # Check Node.js
    if ! check_node; then
        echo -e "${YELLOW}‚ö†Ô∏è Installing Node.js...${NC}"
        install_node
        check_node || exit 1
    fi
    
    # Check NPM
    if ! check_npm; then
        echo -e "${YELLOW}‚ö†Ô∏è Installing NPM...${NC}"
        install_npm
        check_npm || exit 1
    fi
    
    echo "üèóÔ∏è Building component (bootstrap mode)..."
    
    # Build StandaloneBuild first (dependency-free bootstrap)
    if [ ! -f "$COMPONENT_DIR/dist/ts/StandaloneBuild.js" ]; then
        echo "üîß Bootstrapping StandaloneBuild..."
        cd "$COMPONENT_DIR"
        npm install >/dev/null 2>&1
        npx tsc src/ts/StandaloneBuild.ts --outDir dist/ts --module ES2022 --target ES2022 --moduleResolution node >/dev/null 2>&1
    fi
    
    echo "üöÄ Delegating to StandaloneBuild CLI..."
    
    # Use dependency-free StandaloneBuild
    if [ -f "$COMPONENT_DIR/dist/ts/StandaloneBuild.js" ]; then
        node "$COMPONENT_DIR/dist/ts/StandaloneBuild.js" "$@"
    else
        echo -e "${RED}‚ùå StandaloneBuild bootstrap failed${NC}"
        exit 1
    fi
}

# Execute main function with all arguments
main "$@"