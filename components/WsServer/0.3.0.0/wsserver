#!/bin/bash

# Web4 WsServer Component Shell Starter
# Checks environment, builds dependencies, delegates to CLI
# Following standardized Web4 component pattern

set -euo pipefail

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
COMPONENT_DIR="$SCRIPT_DIR"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "ğŸ”Œ Web4 WsServer Component v0.3.0.0 - WebSocket Server Capability"
echo "ğŸ“‚ Component: $COMPONENT_DIR"

# Use Build component for comprehensive build chain
use_build_component() {
    local BUILD_COMPONENT="$COMPONENT_DIR/../../Build/latest"
    
    if [ -x "$BUILD_COMPONENT/build" ]; then
        echo "ğŸ—ï¸ Triggering comprehensive build chain for WsServer..."
        
        # Trigger complete build chain for WsServer component
        "$BUILD_COMPONENT/build" buildComponent WsServer || {
            echo -e "${RED}âŒ Comprehensive build chain failed for WsServer${NC}"
            exit 1
        }
        
        echo -e "${GREEN}âœ… Build chain complete - WsServer ready for execution${NC}"
    else
        echo -e "${YELLOW}âš ï¸ Build component not available, using enhanced fallback...${NC}"
        enhanced_fallback_build
    fi
}

# Enhanced fallback build with dependency detection
enhanced_fallback_build() {
    echo "ğŸ” Detecting WsServer component dependencies..."
    
    # Basic environment check
    command -v node >/dev/null 2>&1 || {
        echo -e "${RED}âŒ Node.js required but not installed${NC}"
        exit 1
    }
    
    command -v npm >/dev/null 2>&1 || {
        echo -e "${RED}âŒ NPM required but not installed${NC}"
        exit 1
    }
    
    # Build WsServer component
    if [ -f "$COMPONENT_DIR/package.json" ]; then
        echo "ğŸ”§ Building WsServer component..."
        cd "$COMPONENT_DIR"
        npm install >/dev/null 2>&1
        npm run build >/dev/null 2>&1 || npx tsc >/dev/null 2>&1
        echo -e "${GREEN}âœ… WsServer built${NC}"
    fi
    
    echo -e "${GREEN}âœ… Enhanced fallback build complete${NC}"
}

# Main execution
main() {
    # Check if this is a usage request (no arguments)
    if [ $# -eq 0 ]; then
        echo "ğŸ” Setting up WsServer environment..."
        use_build_component
        echo "ğŸš€ Delegating to WsServer CLI..."
        
        # Show usage if no arguments
        if [ -f "$COMPONENT_DIR/dist/ts/layer5/WsServerCLI.js" ]; then
            node "$COMPONENT_DIR/dist/ts/layer5/WsServerCLI.js"
        else
            echo -e "${RED}âŒ WsServer CLI not found. Build may have failed.${NC}"
            echo "Try running: npm run build"
            exit 1
        fi
    else
        echo "ğŸ” Setting up WsServer environment..."
        use_build_component
        echo "ğŸš€ Delegating to WsServer CLI..."
        
        # Execute with arguments
        if [ -f "$COMPONENT_DIR/dist/ts/layer5/WsServerCLI.js" ]; then
            node "$COMPONENT_DIR/dist/ts/layer5/WsServerCLI.js" "$@"
        else
            echo -e "${RED}âŒ WsServer CLI not found. Build may have failed.${NC}"
            echo "Try running: npm run build"
            exit 1
        fi
    fi
}

# Execute with all arguments
main "$@"